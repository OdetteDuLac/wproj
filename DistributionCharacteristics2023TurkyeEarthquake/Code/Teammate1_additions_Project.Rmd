---
title: "Distribution and Characteristics of the 2023 Turkye Earthquake"
author: "Safia Bamba, Kamil Orozco, and Amanda Sajewski"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: True
    toc_float: true
    toc_collapsed: true
    theme: paper
geometry: margin=2.54cm
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
---

```{=tex}
\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage
```
```{r setup, include=FALSE}
# Set your working directory
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

# Load your packages
# general
library(tidyverse)
library(here)
library(lubridate)
library(httr)
library(readxl)
# spatial
library(sf)
library(gstat)
library(leaflet)
library(mapview)
library(raster)
# graphics
library(ggplot2)
library(ggthemes)
# GLM
library(agricolae)
library(zoo)

# Set your ggplot theme
theme_set(theme_minimal())
```

# Setup and Data

```{r dataload1, warning=FALSE, message=FALSE}
### administrative boundaries of Turkiye
# install and load rgeoboundaries client for geoBoundaries API
# remotes::install_gitlab("dickoa/rgeoboundaries")
# remotes::install_github("wmgeolab/rgeoboundaries")
# library(rgeoboundaries)

# # load administrative boundaries for Turkiye from rgeoboundaries; CRS = ESPG 4326
# tur.adm0 <- gb_adm0("TUR")
# tur.adm1 <- gb_adm1("TUR")
# tur.adm2 <- gb_adm2("TUR")

#reading in admin boundaries
tur.adm0 <- st_read(here("Data/Shapefiles/TUR_ADM0.shp"))
tur.adm1 <- st_read(here("Data/Shapefiles/TUR_ADM1.shp"))
tur.adm2 <- st_read(here("Data/Shapefiles/TUR_ADM2.shp"))

# plot and check boundaries
plot(st_geometry(tur.adm0))
plot(st_geometry(tur.adm1))
plot(st_geometry(tur.adm2))
re
# save administrative boundary files to shapefile; files can be overwritten when .Rmd is run
st_write(tur.adm0, here("Data/Shapefiles/TUR_ADM0.shp"), delete_layer = TRUE)
st_write(tur.adm1, here("Data/Shapefiles/TUR_ADM1.shp"), delete_layer = TRUE)
st_write(tur.adm2, here("Data/Shapefiles/TUR_ADM2.shp"), delete_layer = TRUE)
```

```{r dataload2, warning=FALSE, message=FALSE}
### earthquake data from USGS Earthquake Catalog
# create bounding box of Turkiye to input coordinates into USGS EC API
tur.bbox <- st_bbox(tur.adm0)
# create string of bounding box coordinates for API url
rectangle <- paste0("minlatitude=", tur.bbox[1], 
                    "&minlongitude=", tur.bbox[2], 
                    "&maxlatitude=", tur.bbox[3], 
                    "&maxlongitude=", tur.bbox[4])
# USGS Earthquake Catalog API query; February 5, 2023 to March 5, 2023; 
# minimum magnitude of 0, want all earthquakes during this period csv format 
tur.USGS.EQC <- GET(paste0("https://earthquake.usgs.gov/fdsnws/event/1/query?format=csv&starttime=2023-02-05&endtime=2023-03-05&", 
                           rectangle, 
                           "&minmagnitude=0.0"))

# parse contents of query and create data frame
EQC.data <- content(tur.USGS.EQC, "text")
EQC.data.df <- read.csv(text = EQC.data)

# preview data
head(EQC.data.df)

# plot earthquake points to see quick distribution
ggplot()+
  geom_sf(data = tur.adm0, fill = "azure", color = "darkgray") +
  geom_point(data = EQC.data.df, aes(x=latitude, y=longitude), color = "darkred", size = 0.5)


# save earthquake data to csv; files can be overwritten when .Rmd is run
write.csv(EQC.data.df, row.names = FALSE, file = here("Data/Tabular/TUR_USGS_EQC_FebMar2023.csv"))
```

```{r dataload3, warning=FALSE, message=FALSE}
### destroyed building data from UN OCHA HDX portal; data set updated daily
# download, unzip, read, and save data set
url <- "https://s3.us-east-1.amazonaws.com/exports-stage.hotosm.org/hotosm_tur_destroyed_buildings_polygons_csv_csv_uid_d3ce51f1-f046-4df9-b0df-2059159c0ece.zip"
temp <- tempfile()
download.file(url, temp)
buildings <- read.csv(unz(temp, "hotosm_tur_destroyed_buildings_polygons_csv.csv"))
unlink(temp)

# plot destroyed buildings points to see quick distribution
ggplot()+
  geom_sf(data = tur.adm0, fill = "azure", color = "darkgray") +
  geom_point(data = buildings, aes(x=latitude, y=longitude), color = "brown", size = 0.5)

# files can be overwritten when .Rmd is run
write.csv(buildings, row.names = FALSE, file = here("Data/Tabular/TUR_HDX_destroyedBuildings.csv"))
```

```{r dataload4, warning=FALSE, message=FALSE}
### twitter earthquake communications data from UN OCHA HDX portal; data set updated monthly
# download data
# download.file("https://data.humdata.org/dataset/a22adc4d-4ae3-4252-a9ba-5d7278f17282/resource/ae7a53d1-7e09-4eaa-9790-13ddcb140e62/download/help_requests_twitter.xlsx",  here("Data/Tabular/TUR_HDX_twitterHelp.xlsx"))
# 
# download.file("https://data.humdata.org/dataset/a22adc4d-4ae3-4252-a9ba-5d7278f17282/resource/ed7a25db-e2fb-402a-a433-e3da0b62d3c4/download/shelter_requests_twitter.xlsx",  here("Data/Tabular/TUR_HDX_twitterShelter.xlsx"))
# 
# download.file("https://data.humdata.org/dataset/a22adc4d-4ae3-4252-a9ba-5d7278f17282/resource/1e6539f1-d7c0-40d2-bfe9-09f4dd0485c7/download/missing_people_reports_twitter.xlsx",  here("Data/Tabular/TUR_HDX_twitterMissingPeople.xlsx"))
# 
# download.file("https://data.humdata.org/dataset/a22adc4d-4ae3-4252-a9ba-5d7278f17282/resource/3f8c3277-cd31-4952-884f-c8ebe2188a00/download/damage_images_twitter.xlsx",  here("Data/Tabular/TUR_HDX_twitterDamageImages.xlsx"))

# read in data
twt.help <- as.data.frame(read_excel(here("Data/Tabular/TUR_HDX_twitterHelp.xlsx")))
twt.shelter <- as.data.frame(read_excel(here("Data/Tabular/TUR_HDX_twitterShelter.xlsx")))
twt.missingPeople <- as.data.frame(read_excel( here("Data/Tabular/TUR_HDX_twitterMissingPeople.xlsx")))
twt.damageImages <- as.data.frame(read_excel(here("Data/Tabular/TUR_HDX_twitterDamageImages.xlsx")))
```

# Rationale and Research Questions

\newpage

# Dataset Information

\newpage

# Exploratory Analysis

```{r interpolation, warning = FALSE, message = FALSE}
#########################
### Spatial Interpolation
#########################

### create spatially interpolated raster surfaces for earthquake and damaged building data

## Earthquake Data: Setup
# maker= EQC df an sf object
EQC.data.sf <- st_as_sf(EQC.data.df, coords = c("longitude", "latitude"), crs = 4326)
# reproject to projected coordinate system from geographic; ESPG 23035; unit = meters
EQC.data.sf.reproj <- st_transform(EQC.data.sf, crs = 23035)
tur.adm0.reproj <- st_transform(tur.adm0, crs = 23035)
tur.adm1.reproj <- st_transform(tur.adm1, crs = 23035)
tur.adm2.reproj <- st_transform(tur.adm2, crs = 23035)
# build blank raster at 10 km resolution; put in same crs as EQC data
blank.rast <- raster(tur.adm0.reproj, res = 10000)


## Earthquake Data: Depth
gs.depth <- gstat(formula = depth ~ 1, locations = EQC.data.sf.reproj, set=list(idp = 2))
idw.depth <- interpolate (blank.rast, gs.depth, debug.level = 0)
idw.rast.depth <- mask(idw.depth, tur.adm0.reproj)
## Earthquake Data: Magnitude
gs.mag <- gstat(formula = mag ~ 1, locations = EQC.data.sf.reproj, set=list(idp = 2))
idw.mag <- interpolate (blank.rast, gs.mag, debug.level = 0)
idw.rast.mag <- mask(idw.mag, tur.adm0.reproj)
plot(idw.rast.mag, 1)

# reproject building data to visualize
buildings.sf <- st_as_sf(buildings, coords = c("longitude", "latitude"), crs = 4326)
buildings.sf.reproj <- st_transform(buildings.sf, crs = 23035)

# create rater dataframes for ggplot
idw.depth.df <- as.data.frame(idw.rast.depth, xy=TRUE) %>% drop_na()
idw.mag.df <- as.data.frame(idw.rast.mag, xy=TRUE) 
```

\newpage

# Analysis

```{r plots/visuals}
#plot of the 2 larger earthquakes 
EQC.data.sf.reproj$time <- ymd_hms(EQC.data.sf.reproj$time)

EQSummary <- EQC.data.sf.reproj %>%
  filter(mag == "7.8" | mag == "7.5") %>%
  group_by(time, mag)
print(EQSummary)

##

#plot of the 2 larger earthquakes 
EQC.data.sf.reproj$time <- ymd_hms(EQC.data.sf.reproj$time)

EQSummary <- EQC.data.sf.reproj %>%
  filter(mag == "7.8" | mag == "7.5") %>%
  group_by(time, mag)
print(EQSummary)
plot(EQSummary)


#plot of building distribution v. depth magnitude raster
ggplot()+
  geom_raster(data = idw.depth.df, aes(x=x, y=y, fill=var1.pred)) +
  scale_fill_viridis_c(name = "depth (km)") +
  geom_sf(data = buildings.sf.reproj, color = "brown", size = 0.5) +
  geom_sf(data = tur.adm2.reproj, fill = "transparent", size = 0.3)

#joining ea. of the twitter data to the admin dataframe
TwtHelpJoin <- merge(x = tur.adm2.reproj,
                 y = twt.help,
                 by.x = "shapeName",
                 by.y = "district")

dim(TwtHelpJoin)


TwtMissPersons <- merge(x = tur.adm2.reproj,
                        y = twt.missingPeople,
                        by.x = "shapeName",
                        by.y = "district")

TwtShelter <- merge(x = tur.adm2.reproj,
                        y = twt.shelter,
                        by.x = "shapeName",
                        by.y = "district")

TwtDamage <- merge(x = tur.adm2.reproj,
                        y = twt.damageImages,
                        by.x = "shapeName",
                        by.y = "district")


mytheme <- theme_classic(base_size = 14) +
  theme(axis.text = element_text(color = "black"), 
        legend.position = "top")

#plots of damaged building points
Defaultplot <- ggplot() + 
  geom_sf(data = tur.adm2.reproj, fill = "azure", color = "darkgray") +
  geom_sf(data = buildings.sf.reproj, color = "brown", size = 0.5) 
Defaultplot

```

#Plot code chunks begin

```{r TwtexploratoryMapsPlots4, fig.align="center", fig.cap="Distirbution of Help Requests", message=FALSE, warning=FALSE, anchor="figure"}

#help twitter data
TWTDataHelp <- ggplot() + 
  geom_sf(data = tur.adm2, fill = "azure", color = "darkgray") +
  geom_sf(data = TwtHelpJoin, aes(fill = help_request_impact_category)) +
  geom_sf(data = EQSummary, color = 'red') +
  scale_color_brewer(palette = "YlOrRd") +
  geom_sf(data = tur.adm2.reproj, fill = "azure", color = "darkgray") +
  geom_sf(data = TwtHelpJoin, aes(fill = help_request_impact_category)) +
  geom_sf(data = EQSummary, color = 'blue', alpha = 0.5) +
  scale_fill_manual(values = 
                      c("Very High" = "#E31A1C", 
                        High = "#FD8D3C", 
                        Medium = "#FECC5C", 
                        Low = "#FFFFB2", 
                        "No Reports" = "darkgray"), 
                    breaks=c("Very High", 'High', 'Medium', "Low", "No Reports")) +
  labs(fill = "Help Request Impact Scores", caption = "*Blue points represent earthquakes with magnitude >7*") +
  ggtitle("Reported Help Requests per Depth Coordinates via Twitter") +
  xlab("Longitude") + ylab("Latitude")
  theme(legend.position = "bottom",
    legend.text = element_text(size= 12), 
    legend.title = element_text(size = 12))
  print(TWTDataHelp)

```

```{r TwtexploratoryMapsPlots5, fig.align="center", fig.cap="Distirbution of Shelter Requests", message=FALSE, warning=FALSE, anchor="figure"}
  
TWTDataShelter <- ggplot() +
  geom_sf(data = tur.adm2.reproj, fill = "transparent") +
  geom_sf(data = TwtShelter,
          aes(fill = shelter_request_impact_category))+
  geom_sf(data = EQSummary, color = 'blue', alpha = 0.5) +
  scale_fill_brewer(palette = "YlOrRd") +
    scale_fill_manual(values = 
                      c("Very High" = "#E31A1C", 
                        High = "#FD8D3C", 
                        Medium = "#FECC5C", 
                        Low = "#FFFFB2", 
                        "No Reports" = "darkgray"), 
                    breaks=c("Very High", 'High', 'Medium', "Low", "No Reports")) +
  labs(fill = "Shelter Request Impact Category", caption = "*Blue points represent earthquakes with magnitude >7*") +
  ggtitle("Reported Needing Shelter via Twitter") +
  xlab("Longitude") + ylab("Latitude")
  theme(legend.position = "bottom", 
        legend.text = element_text(size= 12), 
        legend.title = element_text(size = 12))
print(TWTDataShelter)

```

```{r TwtexploratoryMapsPlots6, fig.align="center", fig.cap="Distirbution of Missing Persons Reports", message=FALSE, warning=FALSE, anchor="figure"}

TWTDataMP <-  ggplot() +
  geom_sf(data = tur.adm2.reproj, fill = "transparent") +
  geom_sf(data = TwtMissPersons,
          aes(fill = missing_people_reports_impact_category))+
  geom_sf(data = EQSummary, color = 'blue', alpha = 0.5) +
    scale_fill_manual(values = 
                      c("Very High" = "#E31A1C", 
                        High = "#FD8D3C", 
                        Medium = "#FECC5C", 
                        Low = "#FFFFB2", 
                        "No Reports" = "darkgray"), 
                    breaks=c("Very High", 'High', 'Medium', "Low", "No Reports")) +
  labs(fill = "Missing Persons Impact Category", caption = "*Blue points represent earthquakes with magnitude >7*") +
  ggtitle("Reported Missing Persons via Twitter") +
  xlab("Longitude") + ylab("Latitude")
  theme(legend.position = "bottom", 
        legend.text = element_text(size= 12), 
        legend.title = element_text(size = 12))
print(TWTDataMP)

```

```{r TwtexploratoryMapsPlots7, fig.align="center", fig.cap="Distirbution of Reported Damage", message=FALSE, warning=FALSE, anchor="figure"}

TWTDataDamage <-  ggplot() +
  geom_sf(data = tur.adm2.reproj, fill = "transparent") +
  geom_sf(data = TwtDamage,
          aes(fill = damage_impact_category)) +
  geom_sf(data = EQSummary, color = 'blue', alpha = 0.5) +
    scale_fill_manual(values = 
                      c("Very High" = "#E31A1C", 
                        High = "#FD8D3C", 
                        Medium = "#FECC5C", 
                        Low = "#FFFFB2", 
                        "No Reports" = "darkgray"), 
                    breaks=c("Very High", 'High', 'Medium', "Low", "No Reports")) +
  labs(fill = "Damage Impact Category", caption = "*Blue points represent earthquakes with magnitude >7*") +
  ggtitle("Reported Damage via Twitter") +
  xlab("Longitude") + ylab("Latitude")
  theme(legend.position = "bottom", 
        legend.text = element_text(size= 12), 
        legend.title = element_text(size = 12))
print(TWTDataDamage)


```

## Questions 3 and 4: What is the distribution of earthquake-related twitter activity? How does this distribution look in relation to the distribution of destroyed buildings?

## Help Requests

Help requests, \@ref(fig:TwtexploratoryMapsPlots4), surrounding the two
\>7 magnitude earthquake points range from Low, Medium, High, and Very
High impact scores. However, the "Very High" impact scores exist nearest
these points and rarely deviate from them (with few exception
boundaries). The density of destroyed buildings is hardly reflected by
the number of help requests in those same areas,
\@ref(fig:exploratoryMapsPlots3).

##Shelter Requests Most boundaries containing "High" and "Very High"
impact categories for requesting shelter,
\@ref(fig:TwtexploratoryMapsPlots5), are located in the boundaries
containing the most damaged/destroyed buildings. Both High and Very High
categories exist on or surrounding the \>7 magnitude earthquake points.
"Low" to "No Reports" exist further from the \>7 magnitude points.

##Missing persons Our visualization plot for missing persons requests,
\@ref(fig:TwtexploratoryMapsPlots6), was most significant in containing
the "No Reports" impact category in comparison to all of our Twitter
data plots. Where the most No Reports exist, these boundaries do not
contain the density (nor any) damaged/destroyed building points.

##Reported Damage All reported damage Very High, High, and Medium
category points, \@ref(fig:TwtexploratoryMapsPlots7), exist where
damaged/destroyed buildings were reported. In comparison, all Low
reported damage exist where there are little to no reported
destroyed/damaged buildings, \@ref(fig:exploratoryMapsPlots3).

## Question 1: \<insert specific question here and add additional subsections for additional questions below, if needed\>

## Question 2:

\newpage

# Summary and Conclusions

\newpage

# References

Administrative boundaries courtesy of
[geoBoundaries](https://www.geoboundaries.org'%3EgeoBoundaries)

\<add references here if relevant, otherwise delete this section\>
